
var volumeOn = true;

window.gameSelectedItem;

Number.prototype.toHHMMSS = function() {
  var hours = Math.floor(this / 3600) < 10 ? ("00" + Math.floor(this / 3600)).slice(-2) : Math.floor(this / 3600);
  var minutes = ("00" + Math.floor((this % 3600) / 60)).slice(-2);
  var seconds = ("00" + (this % 3600) % 60).slice(-2);
  return hours + ":" + minutes + ":" + seconds;
}

$(function(){
  $('.close').click(function(){
    $('.examine-item').removeClass('hidden').addClass('hidden');
    $('.examine-item').find('img').remove();
  })

  $('[data-to-scene]').click(function(){
    var to_scene = $(this).data('to-scene');

    if ($(this).data('acceptitem') && !$(this).data('reveal')) {
      if ($(this).data('unlocked')) {
        $('.scene.visible').removeClass('visible').addClass('hidden');
        $('.scene[data-id="' + to_scene + '"]').removeClass('hidden').addClass('visible')
      } else {
        if (window.gameSelectedItem === $(this).data('acceptitem')) {
          $(this).data('unlocked', true);

          deleteItem($(this).data('acceptitem'));

          $('.scene.visible').removeClass('visible').addClass('hidden');
          $('.scene[data-id="' + to_scene + '"]').removeClass('hidden').addClass('visible');

          playDoorOpening();
          unselect_inventory();
        } else {
          playError();
          return false;
        }
      }
    } else if ($(this).data('reveal') && $(this).data('acceptitem')) {
        if (window.gameSelectedItem === $(this).data('acceptitem')) {
          $(this).data('unlocked', true);

          var result = $('[data-id="' + $(this).data('reveal').toString() + '"]')

          result
            .removeAttr('class')
            .removeAttr('width')
            .removeAttr('style')
            .detach()
            .attr('onclick', 'deleteItem(' + $(this).data('acceptitem') + ');closeExamineBox();' + result.attr('onclick').toString())
            .appendTo('.examine-item');

          $('.examine-item').removeClass('hidden');

          unselect_inventory();
          hideCloseButton();
          disableInventory();
        } else {
          playError();
          return false;
        }
    }
    else {
      $('.scene.visible').removeClass('visible').addClass('hidden');
      $('.scene[data-id="' + to_scene + '"]').removeClass('hidden').addClass('visible')
    }
  })

  $('a.play').on('click', function(e){
    e.preventDefault();

    if (parent.location.hostname !== 'jogoseducativos.github.io' && parent.location.hostname !== 'localhost') {
      window.open('http://jogoseducativos.github.io/jogos-educativos-online');
      return;
    }

    var audioMusic = $('#audioMusic')[0]
    audioMusic.volume = 0.7;
    audioMusic.play()

    window.start_time = +(new Date());

    $('.start').addClass('hidden').removeClass('visible')
    $('.game').addClass('visible').removeClass('hidden')
  })
})

function toggleVolume() {
  var audioMusic = $('#audioMusic')[0]
  volumeOn = !volumeOn;

  if (volumeOn) {
    $('.sound').removeClass('muted');
    audioMusic.play()
  } else {
    $('.sound').addClass('muted');
    audioMusic.pause()
  }
}

function get_item_callback() {
  // $('.game').addClass('hidden').removeClass('visible')
  // $('.finished').addClass('visible').removeClass('hidden')
  // $('.finished .timer').text(((new Date() / 1000) - window.start_time).toHHMMSS())
}

function get_item(elem) {
  playClick();

  $(elem).remove();

  $(elem).attr('width', 16)
    .removeAttr('onclick')
    .removeAttr('class')
    .removeAttr('style')
    .attr('onclick', 'inventorySelect(event, this)')
    .insertBefore('.credits')
    .wrap('<div class="item" onclick="this.firstChild.click()"></div>');

  get_item_callback();

  unselect_inventory();
}

function inventorySelect(event, elem) {
  event.stopPropagation();

  if (elem.getAttribute('data-action') === 'examine' || elem.getAttribute('data-action') === 'combine') {
    $('.examine-item img').remove();

    $(elem).clone()
      .removeAttr('onclick')
      .removeAttr('width')
      .on('click', function() {
        if (elem.getAttribute('data-action') === 'combine' && window.gameSelectedItem === $(elem).data('acceptitem')) {
          playClick();

          $('.examine-item img').remove();
          $(elem).parent().remove();

          var result = $('[data-id="' + $(elem).data('resultitem').toString() + '"]')

          result
            .removeAttr('class')
            .removeAttr('width')
            .removeAttr('style')
            .detach()
            .attr('onclick', 'deleteItem(' + $(elem).data('acceptitem') + ');closeExamineBox();' + result.attr('onclick').toString())
            .appendTo('.examine-item');

          unselect_inventory();
          hideCloseButton();
          disableInventory();
        } else {
          if (elem.getAttribute('data-action') === 'combine') {
            playError();
          }
        }
      })
      .appendTo('.examine-item')
    $('.examine-item').removeClass('hidden');

    return;
  }

  var itemSelected = $('.inventory .selected')

  if (itemSelected.length > 0) {
    unselect_inventory();

    if (elem === itemSelected[0].firstChild) {
      return;
    }
  }

  window.gameSelectedItem = $(elem).data('id');
  $(elem).parent().addClass('selected');
}

function unselect_inventory() {
  $('.inventory .selected').removeClass('selected');
  window.gameSelectedItem = null;
}

function closeExamineBox() {
  showCloseButton();
  enableInventory();
  unselect_inventory();

  $('.close').trigger('click');
}

function showCloseButton() {
  $('.close').removeClass('hidden');
}

function hideCloseButton() {
  $('.close').addClass('hidden');
}

function enableInventory() {
  $('.inventory').removeClass('hidden');
}

function disableInventory() {
  $('.inventory').addClass('hidden')
}

function playClick() {
  $('#audioClick')[0].play();
}

function playError() {
  $('#audioError')[0].play();
}

function playDoorOpening() {
  $('#audioDoorOpening')[0].play();
}

function deleteItem(itemId) {
  $('[data-id="' + itemId + '"]').parent().remove();
}

function checkPassword(okButton) {
  var ok = $(okButton);
  var password = ok.parent();
  var input = password.find('[type="text"]');

  if (password.data('disabled')) {
    return;
  }

  if (input.val().toString() === password.data('pw').toString()) {
    playClick();

    password.data('disabled', true);
    input.val('');

    if (password.data('reveal')) {
      var result = $('[data-id="' + password.data('reveal').toString() + '"]')

      result
        .removeAttr('class')
        .removeAttr('width')
        .removeAttr('style')
        .detach()
        .attr('onclick', 'closeExamineBox();' + result.attr('onclick').toString())
        .appendTo('.examine-item');

      $('.examine-item').removeClass('hidden');

      unselect_inventory();
      hideCloseButton();
      disableInventory();
    }

    checkPasswordSuccess(password.data('name'));
  } else {
    input.val('');
    playError();
  }
}

function checkPasswordSuccess(passwordName) {
  if (passwordName === 'senha-porta') {
    finishGame();
  }
}

function finishGame() {
  $('.game').addClass('hidden');
  $('.finished').removeClass('hidden');
  var audioMusic = $('#audioMusic')[0]
  audioMusic.pause();

  var finishedTime = +(new Date());
  var sub = finishedTime - window.start_time;

  $('.finished .timer').text(Number(Math.floor(sub / 1000)).toHHMMSS())
}
